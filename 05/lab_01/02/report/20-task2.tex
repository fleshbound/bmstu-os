\chapter{Пересчет динамических приоритетов}

В ОС семейств UNIX и Windows динамически пересчитываться могут только приоритеты пользоавтельских процессов.

\section{UNIX/Linux}

Планирование процессов в UNIX основано на приоритете процесса.
Планировщик всегда выбирает процесс с наивысшим приоритетом.
Приоритеты планирования пользовательских процессов изменяются с течением времени, то есть динамически системой в зависимости от использования вычислительных ресурсов, времени ожидания запуска и текущего состояния процесса.

В современных системах UNIX ядро является вытесняющим.
Это значит, что процесс в режиме ядра вытесняется более приоритетным процессом, находящимся так же в режиме ядра.
Это сделано для того, чтобы система могла обслуживать процессы реального времени, например, видео и аудио.

Очередь процессов, готовых к выполнению, формируется согласно приоритетам процессов и принципу вытесняющего циклического планирования.
В первую очередь выполняются процессы с большим приоритетом.
Процессы с одинаковыми приоритетами выполняются в течении кванта времени --- друг за другом, циклически.
В случае, если процесс с более высоким приоритетом поступает в очередь готовых процессов, готовых к выполнению, планировщик вытесняет текущий процесс и предоставляет ресурс более приоритетному процессу.

Приоритет процесса --- это целое числом, находящееся в диапазоне от 0 до 127.
Чем меньше число, тем выше приоритет процесса.
Приоритеты ядра находятся в диапазоне от 0 до 49.
Приоритеты прикладных задач в диапазоне от 50 до 127.
Приоритеты ядра являются фиксиованными величинами, а приоритеты прикладных задач могут изменяться во времени.

Изменение приоритетов прикладных задач зависит от двух факторов: 
\begin{itemize}
	\item фактор <<любезности>>;
	\item последней измеренной величины использования процессора.
\end{itemize}

Фактор <<любезности>> --- целое число в диапазоне от 0 до 39 (по умолчанию 20).
Чем меньше значение фактора <<любезности>>, тем выше приоритет процесса.
Фактор <<любезности>> изменяется только суперпользователем с помощью системного вызова \textbf{nice}.
Фоновые процессы имеют более высокие значения фактора <<любезности>>.

Дескриптор процесса \textbf{struct proc} содержит следующие поля, которые относятся к приоритету процесса:
\begin{itemize}
	\item \textbf{p\_pri} --- текущий приоритет планирования;
	\item \textbf{p\_usrpri} --- приоритет процесса в режиме задачи;
	\item \textbf{p\_cpu} --- результат последнего измерения степени загруженности процессора (процессом);
	\item \textbf{p\_nice} --- фактор <<любезности>>, который устанавливается пользователем.
\end{itemize}

\textbf{p\_pri} используется планировщиком для принятия решения о том, какой процесс отправить на выполнение.
\textbf{p\_pri} и \textbf{p\_usrpri} равны, когда процесс находится в режиме задачи.
Значение \textbf{p\_pri} повышается планировщиком для выполнения процесса в режиме ядра, а \textbf{p\_usrpri} используется для хранения приоритета, который будет назначен процессу, когда тот вернется в режим задачи.

При создании процесса \textbf{p\_cpu} инициализируется нулем.
На каждом тике обработчик таймера увеличивает это поле на 1, до максимального значения, которое равно 127.
Каждую секунду обработчик прерывания инициализирует отложенный вызов процедуры \textbf{schedcpu()}, которая уменьшает значение \textbf{p\_pri} каждого процесса исходя из фактора <<полураспада>>. В системе 4.3BSD фактор <<полураспада>> рассчитывается по формуле \ref{eq:ref1}:

\begin{equation}
	\label{eq:ref1}
	decay = \frac{2 \cdot load\_average}{2 \cdot load\_average + 1} ,
\end{equation} где
\textit{load\_average} --- среднее количество процессов, находящихся в состоянии готовности к выполнению (за последнюю секунду).

Приоритеты для режима задачи всех процессов пересчитываются в процедуре \text{schedcpu()} по формуле \ref{eq:ref2}:

\begin{equation}
	\label{eq:ref2}
	p\_usrpri = PUSER + \frac{p\_cpu}{2} + 2 \cdot p\_nice ,
\end{equation}где \textit{PUSER} --- базовый приоритет в режиме задачи, равный 50.

Ядро системы связывает приоритет сна с событием или ожидаемым ресурсом, из-за которого процесс может блокироваться.
Приоритет сна --- значение приоритета в диапазоне от 0 до 49, зависящее от события или ресурса, по которому произошла блокировка.
Когда процесс <<просыпается>> после того, как был блокирован в системном вызове, ядро устанавливает приоритет сна в поле \textbf{p\_pri}. 
В таблице \ref{tab:bsd} приведены значения приоритетов сна для некоторых событий в системе 4.3BSD.

\begin{table}[h]
	\caption{Таблица приоритетов сна в ОС 4.3BSD}
	\label{tab:bsd}
	\begin{center}
		\begin{tabular}{ |c|c|c|  }
			\hline
			\textbf{Приоритет} & \textbf{Значение} & \textbf{Описание} \\
			\hline
			\texttt{PSWP} & 0 & Свопинг \\
			\hline
			\texttt{PSWP + 1} & 1 & Страничный демон \\
			\hline
			\texttt{PSWP + 1/2/4} & 1/2/4 & Другие действия по обработке памяти \\
			\hline
			\texttt{PINOD} & 10 & Ожидание освобождения inode \\
			\hline
			\texttt{PRIBIO} & 20 & Ожидание дискового ввода-вывода \\
			\hline
			\texttt{PRIBIO + 1} & 21 & Ожидание освобождения буфера \\
			\hline
			\texttt{PZERO} & 25 & ый приоритет \\
			\hline
			\texttt{TTIPRI} & 28 & Ожидание ввода с терминала \\
			\hline
			\texttt{TTOPRI} & 29 & Ожидание вывода с терминала \\
			\hline 
			\texttt{PWAIT} & 30 & Ожидание завершения процесса потомка \\
			\hline
			\texttt{PLOCK} & 35 & Консультативное ожидание блок.
ресурса \\
			\hline
			\texttt{PSLEP} & 40 & Ожидание сигнала \\
			\hline
		\end{tabular}
	\end{center}
\end{table}

Если процесс в последний раз использовал большое количество процессорного времени, то его \textbf{р\_срu} будет увеличен.
Это приведет к росту значения \textbf{p\_usrpri}, из чего последует понижение приоритета.
 
Чем дольше процесс простаивает в очереди на выполнение, тем больше фактор <<полураспада >> уменьшает его \textbf{р\_срu}, что приводит к повышению его приоритета.
Такая схема предотвращает бесконечное откладывание низкоприоритетных процессов.

Применение данной схемы предпочтительнее процессам, осуществляющим много операций ввода-вывода, в противоположность процессам, производящим много вычислений.

То есть динамический пересчёт приоритетов низкоприоритетных процессов позволяет избежать бесконечного откладывания.

\section{Windows}

В Windows процессу при создании назначается базовый приоритет.
Процесс по умолчанию наследует свой базовый приоритет у того процесса, который его создал.
Относительно базового приоритета процесса потоку назначается относительный приоритет.

Планирование осуществляется только на основе приоритетов потоков, готовых к выполнению.
Если поток с более высоким приоритетом становится готовым к выполнению, поток с более низким приоритетом вытесняется планировщиком.
По истечению кванта времени текущего потока, ресурс передается самому приоритетному потоку в очереди готовых на выполнение.

В Windows используется 32 уровня приоритета, которые описываются целыми числами от 0 до 31:
\begin{itemize}
	\item 0 --- зарезервирован для процесса обнуления страниц;
	\item от 0 до 15 --- динамически изменяющиеся уровни;
	\item от 16 до 31 --- уровни реального времени;
	\item 31 --- наивысший приоритет.
\end{itemize}

Уровни приоритета потоков назначаются в зависимости от двух разных позиций: Windows API и ядра Windows.
Сначала Windows API сортирует процессы по классам приоритета, которые были назначены им при создании:
\begin{itemize}
	\item реального времени (Real-time, 4);
	\item высокий (High, 3);
	\item выше обычного (Above Normal, 6);
	\item обычный (Normal, 2);
	\item ниже обычного (Below Normal, 5);
	\item уровень простоя (Idle, 1).
\end{itemize}

Затем назначается относительный приоритет отдельных потоков в рамках процессов:
\begin{itemize}
	\item критичный по времени (Time-critical, 15);
	\item наивысший (Highest, 2);
	\item выше обычного (Above-normal, 1);
	\item обычный (Normal, 0);
	\item ниже обычного (Below-normal, –1);
	\item самый низший (Lowest, –2);
	\item уровень простоя (Idle, –15)
\end{itemize}

В таблице \ref{tab:prioritet} показано соответствие между приоритетами Windows API и ядра системы.

\begin{table}[!h]
	\caption{Соответствие между приоритетами Windows API и ядра Windows}
	\begin{center}
		\begin{tabular}{|c|c|c|c|c|c|c|}
			\hline
			Класс приоритета & Real-time & High & Above &
			Normal & Below Normal & Idle \\ \hline
			Time Critical & 31 & 15 & 15 & 15 & 15 & 15 \\ \hline
			Highest & 26 & 15 & 12 & 10 & 8 & 6 \\ \hline
			Above Normal & 25 & 14 & 11 & 9 & 7 & 5 \\ \hline
			Normal & 24 & 13 & 10 & 8 & 6 & 4 \\ \hline
			Below Normal & 23 & 12 & 9 & 7 & 5 & 3 \\ \hline
			Lowest & 22 & 11 & 8 & 6 & 4 & 2 \\ \hline
			Idle & 16 & 1 & 1 & 1 & 1 & 1 \\ \hline
		\end{tabular}
	\end{center}
	\label{tab:prioritet}
\end{table}

Планировщик повышает текущий приоритет потока в динамическом диапазоне (от 1 до 15) вследствие следующих причин:
\begin{itemize}
	\item повышение приоритета владельцем блокировки;
	\item повышение приоритета после завершения операций ввода/вывода;
	\item повышение приоритета вследствие ввода из пользовательского интерфейса;
	\item повышение приоритета вследствие длительного ожидания ресурса исполняющей системы;
	\item повышение вследствие ожидания объекта ядра;
	\item повышение приоритета в случае, когда поток, готовый к выполнению, не был запущен в течение длительного времени;
	\item повышение приоритета проигрывания мультимедио службой планировщика \textbf{MMCSS}.
\end{itemize}

Текущий приоритет потока в динамическом диапазоне понижается до базового путем вычитания всех его повышений. В таблице \ref{tab:input-output} приведены рекомендуемые значения повышения приоритета для устройств ввода-вывода.

\begin{table}[!h]
	\caption{Рекомендуемые значения повышения приоритета}
	\begin{center}
		\begin{tabular}{|p{100mm}|l|}
			\hline
			\textbf{Устройство} & \textbf{Приращение} \\\hline
			Диск, CD-ROM, параллельный порт, видео & 1 \\ \hline
			Сеть, почтовый ящик, именованный канал, последовательный порт & 2 \\ \hline
			Клавиатура, мышь & 6 \\ \hline
			Звуковая плата & 8 \\ \hline
		\end{tabular}
	\end{center}
	\label{tab:input-output}
\end{table}

\subsection{Диспетчер настройки баланса}

В Windows включен общий механизм ослабления загруженности центрального процессора, который называется \textbf{диспетчером настройки баланса} и является частью системного потока.

Один раз в секунду этот поток сканирует очередь готовых потоков в поиске тех из них, которые находятся в состоянии ожидания около 4 секунд.
Если такой поток будет найден, диспетчер настройки баланса повышает его приоритет до 15 единиц и устанавливает квантовую цель эквивалентной тактовой частоте процессора при подсчете 3 квантовых единиц.
Как только квант истекает, приоритет потока тут же снижается до обычного базового приоритета.
Если поток не был завершен и есть готовый к запуску поток с более высоким уровнем приоритета, поток с пониженным приоритетом возвращается в очередь готовых потоков.

Для минимизации времени своей работы диспетчер настройки баланса сканирует только 16 готовых потоков.
Если на данном уровне приоритета имеется больше потоков, он запоминает то место, на котором остановился, и начинает с него при следующем проходе очереди.
За один проход диспетчер повышает приоритет только у 10 потоков.
Если он обнаруживает 10 потоков, заслуживающих именно этого повышения, он прекращает сканирование на этом месте и начинает его с этого же места при следующем проходе.

\subsection{MMCSS}
Для того, чтобы мультимедийные потоки могли выполняться с минимальными задержками, драйвер \textit{MMCSS} (\textit{MultiMedia Class Scheduler Service}) временно повышают приоритет потоков до уровня, соответствующего их категориям планирования (таблица \ref{tab:category}).
Для того, чтобы другие потоки могли получить ресурс, приоритет снижается до уровня, соответствующего категории \textit{Exhausted}.

Категории планирования --- первичный фактор, определяющий приоритет потоков, зарегистрированных в MMCSS:
\begin{table}[!h]
	\caption{Категории планирования}
	\begin{center}
		\begin{tabular}{|p{40mm}|p{30mm}|p{80mm}|}
			\hline
			\textbf{Категория} & \textbf{Приоритет} & \textbf{Описание} \\
			\hline
			High (Высокая) & 23-26 & Потоки профессионального аудио (Pro
			Audio), запущенные с приоритетом выше, чем у других потоков на системе, за
			исключением критических системных потоков \\
			\hline
			Medium (Средняя) & 16-22 & Потоки, являющиеся частью приложений
			первого плана, например, Windows Media Player \\
			\hline
			Low (Низкая) & 8-15 & Все остальные потоки, не являющиеся частью
			предыдущих категорий \\
			\hline
			Exhausted (Исчерпавших потоков) & 1-7 & Потоки, исчерпавшие свою
			долю времени центрального процессора, выполнение которых продолжиться, только
			если не будут готовы к выполнению другие потоки с более высоким уровнем
			приоритета \\
			\hline
		\end{tabular}
	\end{center}
	\label{tab:category}
\end{table}

\subsection{IRQL}

Для обеспечения поддержки мультизадачности системы, когда исполняется код режима ядра, Windows использует приоритеты прерываний IRQL --  Interrupt Request Level.

Прерывания обслуживаются в порядке их приоритета.
При возникновении прерывания с высоким приоритетом процессор сохраняет информацию о состоянии прерванного потока и активизирует сопоставленный с данным прерыванием диспетчер ловушки.
Последний повышает IRQL и вызывает
процедуру обслуживания прерывания ISR -- Interrupt Service Routine.

После выполнения ISR диспетчер прерывания понижает IRQL процессора до исходного уровня загружает сохраненные ранее данные о состоянии машины.
Прерванный поток возобновляется с той точки, где он был прерван.
Когда ядро понижает IRQL, могут начать обрабатываться ранее замаскированные прерывания с более низким приоритетом.
Тогда вышеописанный процесс повторяется ядром для обработки и этих прерываний.

В ядре IRQL-уровни представлены в виде номеров от 0 до 31, где более высоким номерам соответствуют прерывания с более высоким приоритетом.

Уровни IRQL:
\begin{itemize}
	\item 31 --- наивысший (например, ошибка шины) ;
	\item 30 --- питание;
	\item 29 --- межпроцессорное прерывание;
	\item 28 --- таймер;
	\item 27 --- устройство n;
	\item ...;
	\item 3 --- устройство 1;
	\item 2 --- DPC (deferred procedure call)/dispatch);
	\item 1 --- APC (asynchronous procedure call);
	\item 0 --- низший.
\end{itemize}